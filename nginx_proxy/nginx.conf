user nginx;
worker_processes auto;
error_log /var/log/nginx/error.log warn;
pid /var/run/nginx.pid;

events {
    worker_connections 1024;
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for"';

    access_log /var/log/nginx/access.log main;

    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 65;
    types_hash_max_size 2048;
    client_max_body_size 100M;

    # SSL Configuration - Applied to all HTTPS server blocks
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers 'ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384';
    ssl_prefer_server_ciphers off;
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;
    ssl_session_tickets off;
    ssl_stapling on;
    ssl_stapling_verify on;

    # Define upstream servers for backend and frontend services
    upstream backend_server {
        # Django app (Gunicorn) running in the 'backend' container on its internal port 8000
        server backend:8000;
    }

    upstream frontend_server {
        # React app (served by Nginx) running in the 'frontend' container on its internal port 80
        server frontend:80;
    }

# --- HTTP Server Block: Redirect all HTTP traffic to HTTPS ---
server {
    listen 80;
    # listen [::]:80; # Uncomment if your VPS has IPv6 and you want to listen on it

    # Your domain(s) and IP address
    server_name backend.betblitz.co.zw dashboard.betblitz.co.zw betblitz.co.zw www.betblitz.co.zw 93.127.139.173;

    # Location for Let's Encrypt ACME challenge files (important for certificate renewal)
    # This path inside the container matches the volume mount from /var/www/letsencrypt on the host
    location /.well-known/acme-challenge/ {
        root /var/www/letsencrypt/;
    }

    # Redirect all other HTTP requests to HTTPS
    location / {
        return 301 https://$host$request_uri;
    }
}

# --- HTTPS Server Block for Backend API ---
server {
    listen 443 ssl http2;
    # listen [::]:443 ssl http2; # Uncomment if your VPS has IPv6

    server_name backend.betblitz.co.zw;

    # SSL Certificate paths (inside the Nginx container, using the /etc/nginx/ssl mount from /etc/letsencrypt on host)
    ssl_certificate /etc/nginx/ssl/live/betblitz.co.zw/fullchain.pem;
    ssl_certificate_key /etc/nginx/ssl/live/betblitz.co.zw/privkey.pem;

    # Serve Django static files
    location /static/ {
        alias /srv/www/static/; # Path inside nginx_proxy container where staticfiles_volume is mounted
        expires 7d;
        add_header Pragma public;
        add_header Cache-Control "public, must-revalidate, proxy-revalidate";
    }

    # Serve Django media files
    location /media/ {
        alias /srv/www/media/; # Path inside nginx_proxy container where media_volume is mounted
        
        # CORS headers to allow WhatsApp/Meta and other external services to access media files
        add_header Access-Control-Allow-Origin * always;
        add_header Access-Control-Allow-Methods "GET, HEAD, OPTIONS" always;
        add_header Access-Control-Allow-Headers "Origin, X-Requested-With, Content-Type, Accept, Range" always;
        
        # Cache control
        expires 7d;
        add_header Pragma public;
        add_header Cache-Control "public, must-revalidate, proxy-revalidate";
        
        # Handle OPTIONS requests for CORS preflight
        if ($request_method = OPTIONS) {
            add_header Access-Control-Allow-Origin * always;
            add_header Access-Control-Allow-Methods "GET, HEAD, OPTIONS" always;
            add_header Access-Control-Allow-Headers "Origin, X-Requested-With, Content-Type, Accept, Range" always;
            add_header Content-Length 0;
            add_header Content-Type text/plain;
            return 204;
        }
    }

    # Proxy API requests to the Django backend
    location /crm-api/ {
        proxy_pass http://backend_server; # Django backend expects /crm-api/ directly
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme; # Crucial for Django to know connection is HTTPS
        proxy_set_header Host $http_host;
        proxy_redirect off;
        proxy_buffering off; # Optional: useful for streaming or long-polling if any
    }

    # Proxy Django admin requests
    location /admin/ {
        proxy_pass http://backend_server;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme; # Crucial for Django
        proxy_set_header Host $http_host;
        proxy_redirect off;
    }

    # Root location for backend
    location / {
        proxy_pass http://backend_server;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Host $http_host;
        proxy_redirect off;
    }
}

# --- HTTPS Server Block for Frontend Dashboard ---
server {
    listen 443 ssl http2;
    # listen [::]:443 ssl http2; # Uncomment if your VPS has IPv6

    server_name dashboard.betblitz.co.zw;

    # SSL Certificate paths (inside the Nginx container, using the /etc/nginx/ssl mount from /etc/letsencrypt on host)
    ssl_certificate /etc/nginx/ssl/live/betblitz.co.zw/fullchain.pem;
    ssl_certificate_key /etc/nginx/ssl/live/betblitz.co.zw/privkey.pem;

    # Proxy all requests to the React frontend
    location / {
        proxy_pass http://frontend_server;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme; # Crucial for frontend if it needs to know
        proxy_set_header Host $http_host;
        proxy_redirect off;
        # The Nginx instance inside your 'frontend' container should be configured
        # with 'try_files $uri $uri/ /index.html;' to handle SPA routing.
    }
}

# --- HTTPS Server Block for Main Domain (backwards compatibility) ---
server {
    listen 443 ssl http2;
    # listen [::]:443 ssl http2; # Uncomment if your VPS has IPv6

    server_name betblitz.co.zw www.betblitz.co.zw;

    # SSL Certificate paths (inside the Nginx container, using the /etc/nginx/ssl mount from /etc/letsencrypt on host)
    ssl_certificate /etc/nginx/ssl/live/betblitz.co.zw/fullchain.pem;
    ssl_certificate_key /etc/nginx/ssl/live/betblitz.co.zw/privkey.pem;

    # Serve Django static files
    location /static/ {
        alias /srv/www/static/; # Path inside nginx_proxy container where staticfiles_volume is mounted
        expires 7d;
        add_header Pragma public;
        add_header Cache-Control "public, must-revalidate, proxy-revalidate";
    }

    # Serve Django media files
    location /media/ {
        alias /srv/www/media/; # Path inside nginx_proxy container where media_volume is mounted
        
        # CORS headers to allow WhatsApp/Meta and other external services to access media files
        add_header Access-Control-Allow-Origin * always;
        add_header Access-Control-Allow-Methods "GET, HEAD, OPTIONS" always;
        add_header Access-Control-Allow-Headers "Origin, X-Requested-With, Content-Type, Accept, Range" always;
        
        # Cache control
        expires 7d;
        add_header Pragma public;
        add_header Cache-Control "public, must-revalidate, proxy-revalidate";
        
        # Handle OPTIONS requests for CORS preflight
        if ($request_method = OPTIONS) {
            add_header Access-Control-Allow-Origin * always;
            add_header Access-Control-Allow-Methods "GET, HEAD, OPTIONS" always;
            add_header Access-Control-Allow-Headers "Origin, X-Requested-With, Content-Type, Accept, Range" always;
            add_header Content-Length 0;
            add_header Content-Type text/plain;
            return 204;
        }
    }

    # Proxy API requests (using /crm-api/ prefix) to the Django backend
    location /crm-api/ {
        proxy_pass http://backend_server; # Django backend expects /crm-api/ directly
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme; # Crucial for Django to know connection is HTTPS
        proxy_set_header Host $http_host;
        proxy_redirect off;
        proxy_buffering off; # Optional: useful for streaming or long-polling if any
    }

    # Proxy Django admin requests
    location /admin/ {
        proxy_pass http://backend_server;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme; # Crucial for Django
        proxy_set_header Host $http_host;
        proxy_redirect off;
    }

    # Proxy all other requests to the React frontend
    location / {
        proxy_pass http://frontend_server;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme; # Crucial for frontend if it needs to know
        proxy_set_header Host $http_host;
        proxy_redirect off;
        # The Nginx instance inside your 'frontend' container should be configured
        # with 'try_files $uri $uri/ /index.html;' to handle SPA routing.
    }

    # Optional: Error and access logs for HTTPS traffic
    # access_log /var/log/nginx/betblitz.co.zw.ssl.access.log;
    # error_log /var/log/nginx/betblitz.co.zw.ssl.error.log;

} # End of HTTPS server block

} # End of http block
